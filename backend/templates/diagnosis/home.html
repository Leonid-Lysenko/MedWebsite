{% extends 'diagnosis/base.html' %}
{% load static %}

{% block title %}Главная - Медицинский диагностический помощник{% endblock %}

{% block extra_css %}
<style>
    /* Основные стили для главной страницы */
    body {
        background: #667eea;
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .medical-card {
        background: #ffffff;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        margin: 20px 10px;
    }
    
    /* Стили для чекбоксов симптомов */
    .symptom-checkbox {
        cursor: pointer;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        transition: background-color 0.2s ease;
    }
    
    .symptom-checkbox:hover {
        background-color: #f8f9fa;
    }
    
    .symptom-checkbox input[type='checkbox'] {
        transform: scale(1.1);
        margin-right: 8px;
    }
    
    /* Стиль для основной кнопки анализа */
    .btn-medical {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        border-radius: 50px;
        padding: 12px 30px;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .btn-medical:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        color: white;
    }
    
    /* Стиль для кнопок пагинации */
    .btn-pagination {
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
    }

    /* Стили для статистических чисел */
    .stat-number {
        font-size: 2.2rem;
        font-weight: bold;
        color: #ffffff;
    }

    /* Анимация появления симптомов */
    .symptom-item {
        animation: fadeInUp 0.5s ease-out;
        animation-fill-mode: both;
    }

    /* Подсветка найденного текста при поиске */
    .highlight {
        background-color: #ffeb3b;
        padding: 0 2px;
        border-radius: 2px;
        font-weight: bold;
    }

    /* Стили для пагинации */
    .pagination-controls {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #e9ecef;
        margin-top: 20px;
    }
    
    .page-info {
        font-weight: 500;
        color: #495057;
    }
    
    /* Стили для статуса системы */
    .system-status {
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-online {
        background-color: #28a745;
    }
    
    .status-offline {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Заголовок страницы -->
            <div class="text-center text-white mb-4">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="fas fa-stethoscope me-3"></i>
                    Медицинский Диагностический Помощник
                </h1>
                <p class="lead mb-0">
                    AI-помощник для предварительной диагностики заболеваний на основе симптомов
                </p>
            </div>

            <!-- Блок статистики системы -->
            <div class="row text-center mb-4">
                <div class="col-md-4 mb-3">
                    <div class="text-white">
                        <div class="stat-number">{{ diseases_count }}</div>
                        <p class="mb-0">Заболеваний в базе</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="text-white">
                        <div class="stat-number">{{ symptoms_count }}</div>
                        <p class="mb-0">Симптомов для анализа</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="text-white">
                        <div class="stat-number">
                            ML
                        </div>
                        <p class="mb-0">Машинное обучение</p>
                    </div>
                </div>
            </div>

            <!-- Рекомендация для пользователей -->
            <div class="text-center text-white mb-4">
                <p class="mb-0">
                    <em>Перед использованием изучите раздел
                        <strong>
                            <a href="{% url 'how_to_use' %}" style="color: #ffffff; text-decoration: underline;">
                                "Как пользоваться"
                            </a>
                        </strong>
                        для точных результатов
                    </em>
                </p>
            </div>

            <!-- Статус системы  -->
            <div class="system-status {% if model_loaded %}alert alert-success{% else %}alert alert-danger{% endif %}">
                <div class="d-flex align-items-center">
                    <span class="status-indicator {% if model_loaded %}status-online{% else %}status-offline{% endif %}"></span>
                    <strong>Статус системы:</strong>
                    <span class="ms-2">
                        {% if model_loaded %}
                        ML-модель загружена и готова к работе
                        {% else %}
                        ML-модель не загружена: {{ model_error }}
                        {% endif %}
                    </span>
                </div>
                {% if not model_loaded %}
                <div class="mt-2">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        В демонстрационном режиме доступен только просмотр
                    </small>
                </div>
                {% endif %}
            </div>

            <!-- Основная карточка с формой ввода симптомов -->
            <div class="medical-card p-4 p-md-5 mb-4">
                <form method="POST" action="{% url 'predict' %}" {% if not model_loaded %}onsubmit="alert('ML-модель не загружена. Диагностика временно недоступна.'); return false;"{% endif %}>
                    {% csrf_token %}

                    <!-- Блок поиска симптомов -->
                    <div class="mb-4">
                        <label class="form-label fw-bold text-primary mb-3">
                            <i class="fas fa-search me-2"></i>
                            Поиск симптомов:
                        </label>
                        
                        <!-- Поле поиска с кнопками -->
                        <div class="input-group input-group-lg mb-3">
                            <span class="input-group-text bg-primary text-white">
                                <i class="fas fa-search"></i>
                            </span>
                            <input
                                type="text"
                                id="symptomSearch"
                                class="form-control"
                                placeholder="Начните вводить название симптома..."
                                {% if not model_loaded %}disabled{% endif %}
                            />
                            <button
                                class="btn btn-outline-secondary"
                                type="button"
                                id="clearSearch"
                                {% if not model_loaded %}disabled{% endif %}
                            >
                                <i class="fas fa-times"></i> Очистить
                            </button>
                        </div>
                        
                        <!-- Счетчики результатов -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <small class="text-muted" id="searchResultsCount">
                                Найдено: <span id="foundCount">{{ symptoms|length }}</span> из {{ symptoms|length }} симптомов
                            </small>
                            <small class="text-muted" id="selectedCountBadge">
                                Выбрано: <span id="selectedCount">0</span>
                            </small>
                        </div>
                    </div>

                    <!-- Баннер выбранных симптомов -->
                    <div
                        class="alert alert-success mb-4"
                        id="selectedSymptomsBanner"
                        style="display: none"
                    >
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Выбранные симптомы:</strong>
                                <span id="selectedSymptomsList"></span>
                            </div>
                            <button
                                class="btn btn-sm btn-outline-success"
                                id="clearAllSymptoms"
                                type="button"
                                {% if not model_loaded %}disabled{% endif %}
                            >
                                <i class="fas fa-times me-1"></i>Очистить все
                            </button>
                        </div>
                    </div>

                    <!-- Блок выбора симптомов -->
                    <div class="mb-4">
                        <label class="form-label fw-bold text-primary mb-3">
                            <i class="fas fa-notes-medical me-2"></i>
                            Выберите симптомы (отметьте все подходящие):
                        </label>

                        <!-- Верхняя кнопка анализа (появляется при выборе симптомов) -->
                        <div class="text-center mb-4" id="topAnalyzeBtn" style="display: none">
                            <button
                                type="submit"
                                class="btn btn-medical text-white px-4 py-3"
                                {% if not model_loaded %}disabled{% endif %}
                            >
                                <i class="fas fa-search me-2"></i>
                                Анализировать выбранные симптомы (<span class="symptom-count">0</span>)
                            </button>
                            <div class="mt-2">
                                <small class="text-muted">или продолжите выбор симптомов ниже</small>
                            </div>
                        </div>

                        <!-- Информационное сообщение -->
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            {% if model_loaded %}
                            Модель проанализирует выбранные симптомы и определит наиболее вероятные заболевания
                            {% else %}
                            <strong>Демонстрационный режим:</strong> ML-модель временно недоступна
                            {% endif %}
                        </div>

                        <!-- Сетка симптомов -->
                        <div class="row g-3" id="symptoms-grid">
                            {% for symptom in symptoms %}
                            <div class="col-md-6 col-lg-4 symptom-item">
                                <div class="form-check p-3 symptom-checkbox border rounded h-100">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        name="symptoms"
                                        value="{{ symptom }}"
                                        id="symptom{{ forloop.counter }}"
                                        data-symptom="{{ symptom|lower }}"
                                        {% if not model_loaded %}disabled{% endif %}
                                    />
                                    <label
                                        class="form-check-label w-100"
                                        for="symptom{{ forloop.counter }}"
                                        data-original="{{ symptom }}"
                                    >
                                        {{ symptom }}
                                    </label>
                                </div>
                            </div>
                            {% empty %}
                            <!-- Сообщение при отсутствии симптомов -->
                            <div class="col-12">
                                <div class="alert alert-warning text-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Симптомы не загружены
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Элементы управления пагинацией -->
                        <div class="pagination-controls text-center" id="paginationControls">
                            <button type="button" class="btn btn-outline-primary btn-pagination me-2" id="prevPage" disabled>
                                <i class="fas fa-chevron-left me-1"></i>Назад
                            </button>
                            <span class="mx-3 page-info" id="pageInfo">Страница 1 из 7</span>
                            <button type="button" class="btn btn-outline-primary btn-pagination ms-2" id="nextPage">
                                Вперед<i class="fas fa-chevron-right ms-1"></i>
                            </button>
                            <div class="mt-2">
                                <small class="text-muted">Показано <span id="shownCount">45</span> из {{ symptoms|length }} симптомов</small>
                            </div>
                        </div>

                        <!-- Сообщение при отсутствии результатов поиска -->
                        <div
                            class="alert alert-warning text-center mt-4"
                            id="noResultsMessage"
                            style="display: none"
                        >
                            <i class="fas fa-search me-2"></i>
                            Симптомы не найдены. Попробуйте изменить запрос.
                        </div>
                    </div>

                    <!-- Основная кнопка отправки формы -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-medical text-white px-5 py-3" {% if not model_loaded %}disabled{% endif %}>
                            <i class="fas fa-search me-2"></i>
                            Анализировать выбранные симптомы (<span class="symptom-count">0</span>)
                        </button>
                    </div>
                </form>
            </div>

            <!-- Важное предупреждение для пользователей -->
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Важно:</strong> Данная система является помощником для предварительной диагностики. 
                Для точного диагноза и лечения обязательно обратитесь к врачу!
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Глобальные переменные для управления состоянием интерфейса
    let selectedSymptoms = new Set();
    let allSymptoms = [];
    let currentPage = 1;
    const symptomsPerPage = 45;
    let totalPages = 1;
    let currentSearchTerm = '';

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        initializePagination();
        setupEventListeners();
        updateSelectedCount();
        
        // Простая отладочная информация
        console.log('Система диагностики инициализирована');
        console.log('Загружено симптомов:', allSymptoms.length);
        console.log('Выбрано симптомов:', selectedSymptoms.size);
    });

    // Инициализация пагинации симптомов
    function initializePagination() {
        const symptomItems = document.querySelectorAll('.symptom-item');
        allSymptoms = Array.from(symptomItems);
        totalPages = Math.ceil(allSymptoms.length / symptomsPerPage);
        
        // Скрываем все симптомы и показываем только первую страницу
        allSymptoms.forEach(item => {
            item.style.display = 'none';
        });
        
        showPage(1);
        
        // Восстанавливаем выбранные симптомы при перезагрузке страницы
        document.querySelectorAll('input[name="symptoms"]:checked').forEach(checkbox => {
            selectedSymptoms.add(checkbox.value);
        });
        updateSelectedCount();
    }

    // Настройка обработчиков событий
    function setupEventListeners() {
        // Обработчик поиска симптомов
        document.getElementById('symptomSearch').addEventListener('input', function(e) {
            currentSearchTerm = e.target.value.trim().toLowerCase();
            currentPage = 1;
            performSearch(currentSearchTerm);
        });

        // Обработчик очистки поиска
        document.getElementById('clearSearch').addEventListener('click', function() {
            document.getElementById('symptomSearch').value = '';
            currentSearchTerm = '';
            currentPage = 1;
            performSearch('');
        });

        // Обработчик очистки всех выбранных симптомов
        document.getElementById('clearAllSymptoms').addEventListener('click', clearAllSymptoms);
        
        // Обработчики пагинации
        document.getElementById('prevPage').addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                showPage(currentPage - 1);
            }
        });
        
        document.getElementById('nextPage').addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage < totalPages) {
                showPage(currentPage + 1);
            }
        });

        // Обработчик выбора симптомов
        document.addEventListener('change', function(e) {
            if (e.target.name === 'symptoms') {
                handleSymptomSelection(e.target);
            }
        });
    }

    // Отображение конкретной страницы симптомов
    function showPage(page) {
        currentPage = page;
        
        // Скрываем все симптомы
        allSymptoms.forEach(item => {
            item.style.display = 'none';
        });
        
        // Показываем симптомы для текущей страницы
        const startIndex = (page - 1) * symptomsPerPage;
        const endIndex = startIndex + symptomsPerPage;
        
        for (let i = startIndex; i < endIndex && i < allSymptoms.length; i++) {
            allSymptoms[i].style.display = 'block';
        }
        
        updatePaginationInfo();
    }

    // Обновление информации о пагинации
    function updatePaginationInfo() {
        document.getElementById('pageInfo').textContent = `Страница ${currentPage} из ${totalPages}`;
        const shownCount = Math.min(symptomsPerPage, allSymptoms.length - (currentPage - 1) * symptomsPerPage);
        document.getElementById('shownCount').textContent = shownCount;
        
        // Блокировка кнопок навигации при достижении границ
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
    }

    // Выполнение поиска симптомов
    function performSearch(searchTerm) {
        if (searchTerm === '') {
            // Если поиск пустой, возвращаем обычную пагинацию
            showPage(1);
            document.getElementById('noResultsMessage').style.display = 'none';
            document.getElementById('paginationControls').style.display = 'block';
            updateSearchResultsCount(allSymptoms.length);
            
            document.getElementById('prevPage').style.display = 'inline-block';
            document.getElementById('nextPage').style.display = 'inline-block';
            return;
        }

        let foundCount = 0;
        
        // Фильтрация симптомов по поисковому запросу
        allSymptoms.forEach((item) => {
            const label = item.querySelector('label');
            const originalText = label.dataset.original.toLowerCase();
            const isMatch = originalText.includes(searchTerm);
            
            if (isMatch) {
                foundCount++;
                item.style.display = 'block';
                
                // Подсветка найденного текста
                const highlightedText = label.dataset.original.replace(
                    new RegExp(searchTerm, 'gi'),
                    match => `<span class="highlight">${match}</span>`
                );
                label.innerHTML = highlightedText;
            } else {
                item.style.display = 'none';
                label.innerHTML = label.dataset.original;
            }
        });

        // Управление отображением сообщений и элементов управления
        document.getElementById('noResultsMessage').style.display = foundCount === 0 ? 'block' : 'none';
        document.getElementById('paginationControls').style.display = foundCount === 0 ? 'none' : 'block';
        updateSearchResultsCount(foundCount);
        
        if (foundCount > 0) {
            // В режиме поиска скрываем стандартную пагинацию
            document.getElementById('pageInfo').textContent = `Найдено: ${foundCount}`;
            document.getElementById('shownCount').textContent = foundCount;
            document.getElementById('prevPage').style.display = 'none';
            document.getElementById('nextPage').style.display = 'none';
        } else {
            document.getElementById('prevPage').style.display = 'inline-block';
            document.getElementById('nextPage').style.display = 'inline-block';
        }
    }

    // Обработка выбора/снятия выбора симптома
    function handleSymptomSelection(checkbox) {
        const symptomValue = checkbox.value;

        if (checkbox.checked) {
            selectedSymptoms.add(symptomValue);
            checkbox.parentElement.style.backgroundColor = '#e8f4fd';
        } else {
            selectedSymptoms.delete(symptomValue);
            checkbox.parentElement.style.backgroundColor = '';
        }

        updateSelectedCount();
    }

    // Обновление счетчика выбранных симптомов
    function updateSelectedCount() {
        const count = selectedSymptoms.size;
        
        // Обновление всех элементов с количеством симптомов
        document.querySelectorAll('.symptom-count').forEach(element => {
            element.textContent = count;
        });

        const selectedCountElement = document.getElementById('selectedCount');
        if (selectedCountElement) {
            selectedCountElement.textContent = count;
        }

        const selectedCountBadge = document.getElementById('selectedCountBadge');
        if (selectedCountBadge) {
            selectedCountBadge.innerHTML = `Выбрано: <strong>${count}</strong>`;
        }

        // Показ/скрытие верхней кнопки анализа
        const topBtn = document.getElementById('topAnalyzeBtn');
        if (topBtn) {
            topBtn.style.display = count > 0 ? 'block' : 'none';
        }

        updateSelectedSymptomsBanner();
    }

    // Обновление счетчика результатов поиска
    function updateSearchResultsCount(found) {
        const foundCountElement = document.getElementById('foundCount');
        if (foundCountElement) {
            foundCountElement.textContent = found;
        }
    }

    // Обновление баннера выбранных симптомов
    function updateSelectedSymptomsBanner() {
        const banner = document.getElementById('selectedSymptomsBanner');
        const symptomsList = document.getElementById('selectedSymptomsList');

        if (banner && symptomsList) {
            if (selectedSymptoms.size > 0) {
                symptomsList.textContent = Array.from(selectedSymptoms).join(', ');
                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
            }
        }
    }

    // Очистка всех выбранных симптомов
    function clearAllSymptoms() {
        document.querySelectorAll('input[name="symptoms"]:checked').forEach(checkbox => {
            checkbox.checked = false;
            checkbox.parentElement.style.backgroundColor = '';
        });

        selectedSymptoms.clear();
        updateSelectedCount();
    }
</script>
{% endblock %}